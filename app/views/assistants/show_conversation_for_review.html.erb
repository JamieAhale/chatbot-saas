<div class="d-flex justify-content-between align-items-center mb-4">
  <div class="d-flex align-items-center">
    <h1 class="mb-0 me-3"><%= (@conversation.title.presence || "Untitled").gsub(/\A"|"\Z/, '') %></h1>
    <p class="mb-0 me-1 bg-light border rounded p-2 d-inline-block">
      <strong>ID:</strong> <%= @conversation.id %>
    </p>
    <div class="dropdown me-3">
      <button class="btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 25px; color: #333; font-weight: bold;">
        &#x22EE;
      </button>
      <ul class="dropdown-menu">
        <li>
          <%= button_to "Delete", conversation_path(@conversation), 
              method: :delete, 
              class: "dropdown-item text-danger",
              onclick: "return confirm('This cannot be undone. Are you sure?');" %>
        </li>
        <li>
          <%= button_to "Mark as Resolved", mark_resolved_conversation_path(@conversation), 
              method: :patch, 
              class: "dropdown-item text-success",
              onclick: "return confirm('Are you sure you want to mark this conversation as resolved?');" %>
        </li>
        <li>
          <%= button_to "Dismiss", dismiss_conversation_path(@conversation), 
              method: :patch, 
              class: "dropdown-item",
              onclick: "return confirm('Are you sure you want to dismiss this conversation?');" %>
        </li>
      </ul>
    </div>
  </div>
  <%= link_to "Back to Conversations for Review", conversations_for_review_path(search: params[:search]), class: "btn btn-outline-secondary" %>
</div>

<% if @conversation.summary_missing? %>
  <div id="no-summary-banner" class='mb-4'>
    <%= button_to "Generate Summary", generate_summary_conversation_path(@conversation), 
        method: :post, 
        class: "btn btn-outline-primary", 
        id: "generate-summary-btn" %>
  </div>
  <div id="loading-spinner-container" class='m-4' style="display: none;">
    <i class="fas fa-spinner fa-spin ms-2" style="font-size: 2em;"></i>
  </div>
<% else %>
  <div class="alert alert-danger">
    <p class="mb-0"><strong>Summary:</strong> <%= @conversation.summary %></p>
  </div>
<% end %>

<!-- Chat messages container with scrollable area -->
<div class="border rounded p-3 mb-3" style="height: 500px; overflow-y: auto;">
  <% @messages.each do |message| %>
    <!-- Store message timestamp in a data attribute -->
    <div class="text-muted small mb-1" data-timestamp="<%= message.created_at.iso8601 %>">
      <!-- Placeholder for JavaScript to fill -->
    </div>
    <!-- User message bubble (left-aligned) -->
    <div class="d-flex justify-content-start mb-3">
      <p class="bg-light p-2 rounded d-inline-block text-break" style="max-width: 75%;">
        <strong>User:</strong> <%= message.user_query %>
      </p>
    </div>
    
    <!-- Assistant message bubble (right-aligned) -->
    <div class="d-flex justify-content-end mb-3">
      <p class="bg-secondary text-white p-2 rounded d-inline-block text-break" style="max-width: 75%;">
        <strong>Assistant:</strong> 
        <%= message.assistant_response
              .split(/\[\d+,\s*pp\.|\[cite:/).first&.strip
              .gsub("\n", '<br>')
              .gsub(/\*\*(.+?)\*\*/, '<strong>\1</strong>')
              .html_safe %>
      </p>
    </div>
  <% end %>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const timestampElements = document.querySelectorAll('[data-timestamp]');

  timestampElements.forEach(element => {
    const timestamp = element.getAttribute('data-timestamp');
    const date = new Date(timestamp);
    const formattedDate = date.toLocaleString(undefined, {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    element.textContent = formattedDate;
  });

  const generateSummaryBtn = document.getElementById('generate-summary-btn');
  const noSummaryBanner = document.getElementById('no-summary-banner');
  const loadingSpinnerContainer = document.getElementById('loading-spinner-container');

  if (generateSummaryBtn) {
    generateSummaryBtn.addEventListener('click', function() {
      noSummaryBanner.style.display = 'none';
      loadingSpinnerContainer.style.display = 'block';
    });
  }
});
</script>