<style>
  .pagination .page-item .page-link {
    color: #6c757d; /* Grey color for text */
  }

  .pagination .page-item.active .page-link {
    background-color: #6c757d; /* Grey color for active background */
    border-color: #6c757d; /* Grey color for active border */
    color: white; /* White text for active page */
  }

  .pagination .page-item .page-link:hover {
    color: #5a6268; /* Slightly darker grey on hover */
  }

  /* Custom checkbox styles */
  .custom-checkbox-container {
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    user-select: none;
    width: 20px;
    height: 20px;
    margin: 0;
    position: relative;
  }

  .checkbox-cell {
    padding: 0.75rem 0.5rem !important;
    width: 40px;
    text-align: center;
  }

  .custom-checkbox-container input {
    position: absolute;
    opacity: 0;
    cursor: pointer;
    height: 0;
    width: 0;
  }

  .checkmark {
    position: absolute;
    top: 0;
    left: 0;
    height: 20px;
    width: 20px;
    background-color: #fff;
    border: 2px solid #ddd;
    border-radius: 4px;
    transition: all 0.2s ease-in-out;
  }

  .custom-checkbox-container:hover input ~ .checkmark {
    border-color: #666;
  }

  .custom-checkbox-container input:checked ~ .checkmark {
    background-color: #28a745;
    border-color: #28a745;
  }

  .checkmark:after {
    content: "";
    position: absolute;
    display: none;
    left: 6px;
    top: 2px;
    width: 6px;
    height: 12px;
    border: solid white;
    border-width: 0 2px 2px 0;
    transform: rotate(45deg);
    transition: all 0.2s ease-in-out;
  }

  .custom-checkbox-container input:checked ~ .checkmark:after {
    display: block;
    animation: checkmark 0.2s ease-in-out forwards;
  }

  @keyframes checkmark {
    0% {
      opacity: 0;
      transform: rotate(45deg) scale(0.5);
    }
    100% {
      opacity: 1;
      transform: rotate(45deg) scale(1);
    }
  }

  /* Animation styles for bulk actions */
  .bulk-actions-container {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease-in-out;
    margin-top: 0;
    margin-bottom: 0;
  }

  .bulk-actions-container.visible {
    max-height: 50px;
    opacity: 1;
    margin-bottom: 1rem;
  }

  .bulk-action-btn {
    transform: translateY(0);
    transition: transform 0.3s ease-in-out;
  }

  /* Dropdown menu styles */
  .action-dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-toggle {
    background: none;
    border: none;
    color: #6c757d;
    padding: 0.375rem;
    cursor: pointer;
    transition: color 0.2s ease;
  }

  .dropdown-toggle:hover {
    color: #343a40;
  }

  .dropdown-menu {
    min-width: 120px;
  }

  .dropdown-item {
    padding: 0.5rem 1rem;
    font-size: 0.875rem;
  }

  .dropdown-item i {
    width: 1rem;
    margin-right: 0.5rem;
    text-align: center;
  }

  /* Modal styles */
  .modal-confirm .modal-content {
    padding: 1.5rem;
    border: none;
    border-radius: 0.5rem;
  }

  .modal-confirm .modal-header {
    border: none;
    padding: 0 0 1rem 0;
  }

  .modal-confirm .modal-body {
    padding: 0 0 1.5rem 0;
  }

  .modal-confirm .modal-footer {
    border: none;
    padding: 0;
    justify-content: flex-start;
  }

  .modal-confirm .btn-modal {
    padding: 0.5rem 1.5rem;
    margin-right: 0.5rem;
  }
</style>

<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Conversation History</h1>
    <div class="d-flex">
      <% if params[:search].present? %>
        <%= link_to conversations_path, class: "btn btn-outline-secondary me-1" do %>
          <i class="fas fa-times me-1"></i> Clear Search
        <% end %>
      <% end %>

      <%= form_with url: conversations_path, method: :get, local: true, class: 'd-flex' do %>
        <div class="input-group">
          <%= text_field_tag :search, params[:search], class: 'form-control', placeholder: 'Search conversations...' %>
          <button type="submit" class="btn btn-outline-secondary">
            <i class="fas fa-search"></i>
          </button>
        </div>
      <% end %>
    </div>
  </div>

  <% if @conversations.any? %>
    <div class="bulk-actions-container">
      <div class="d-flex">
        <%= form_with url: delete_selected_conversations_path, method: :delete, local: true, id: 'delete_conversations_form' do %>
          <%= submit_tag "Delete Selected", class: "btn btn-danger me-2 bulk-action-btn", onClick: "return confirm('Are you sure you want to delete the selected conversations? This cannot be undone.')", id: 'delete_selected_button' %>
        <% end %>

        <%= form_with url: flag_selected_conversations_path, method: :patch, local: true, id: 'flag_conversations_form' do %>
          <%= submit_tag "Flag Selected for Review", class: "btn btn-warning bulk-action-btn", onClick: "return confirm('Are you sure you want to flag the selected conversations for review?')", id: 'flag_selected_button' %>
        <% end %>
      </div>
    </div>

    <table class="table table-striped mt-1 uniform-table">
      <thead>
        <tr>
          <th> </th>
          <th>Title</th>
          <th>ID</th>
          <th>Total Messages</th>
          <th>Date</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% @conversations.each do |conversation| %>
          <tr>
            <td class="checkbox-cell">
              <label class="custom-checkbox-container">
                <%= check_box_tag "conversation_ids[]", conversation.id, false, class: 'conversation-checkbox' %>
                <span class="checkmark"></span>
              </label>
            </td>
            <td>
              <%= link_to (conversation.title.presence || "Untitled").gsub(/\A"|"\Z/, ''), show_conversation_path(conversation, search: params[:search]), class: "fw-bold text-decoration-underline" %>
            </td>
            <td>
              <%= conversation.id %>
            </td>
            <td>
              <%= conversation.query_and_responses.count * 2 %>
            </td>
            <td>
              <%= conversation.created_at.strftime("#{conversation.created_at.day.ordinalize} %B %Y") %>
            </td>
            <td class="text-end">
              <div class="action-dropdown">
                <button class="dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  <i class="fas fa-ellipsis-v"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <%= link_to show_conversation_path(conversation), class: "dropdown-item" do %>
                      <i class="fas fa-eye"></i> View
                    <% end %>
                  </li>
                  <li>
                    <%= form_with url: flag_selected_conversations_path, method: :patch, local: true, id: "flag-form-#{conversation.id}" do %>
                      <%= hidden_field_tag "conversation_ids[]", conversation.id %>
                      <%= button_tag type: :button, class: "dropdown-item w-100 text-start", data: { bs_toggle: "modal", bs_target: "#flagModal#{conversation.id}" } do %>
                        <i class="fas fa-flag"></i> Flag for Review
                      <% end %>
                    <% end %>
                  </li>
                  <li>
                    <%= form_with url: delete_selected_conversations_path, method: :delete, local: true, id: "delete-form-#{conversation.id}" do %>
                      <%= hidden_field_tag "conversation_ids[]", conversation.id %>
                      <%= button_tag type: :button, class: "dropdown-item w-100 text-start text-danger", data: { bs_toggle: "modal", bs_target: "#deleteModal#{conversation.id}" } do %>
                        <i class="fas fa-trash"></i> Delete
                      <% end %>
                    <% end %>
                  </li>
                </ul>
              </div>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="d-flex justify-content-center mb-4">
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <% if @conversations.current_page > 1 %>
            <li class="page-item">
              <%= link_to 'Previous', conversations_path(page: @conversations.current_page - 1), class: 'page-link' %>
            </li>
          <% end %>

          <% (1..@conversations.total_pages).each do |page| %>
            <li class="page-item <%= 'active' if page == @conversations.current_page %>">
              <%= link_to page, conversations_path(page: page), class: 'page-link' %>
            </li>
          <% end %>

          <% if @conversations.current_page < @conversations.total_pages %>
            <li class="page-item">
              <%= link_to 'Next', conversations_path(page: @conversations.current_page + 1), class: 'page-link' %>
            </li>
          <% end %>
        </ul>
      </nav>
    </div>
  <% else %>
    <p class="mt-4">No conversations found.</p>
  <% end %>
</div>

<!-- Flag Confirmation Modal -->
<% @conversations.each do |conversation| %>
  <div class="modal fade modal-confirm" id="flagModal<%= conversation.id %>" tabindex="-1" aria-labelledby="flagModalLabel<%= conversation.id %>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="flagModalLabel<%= conversation.id %>">Flag Conversation for Review</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to flag this conversation for review?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-modal" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-warning btn-modal" onclick="document.getElementById('flag-form-<%= conversation.id %>').submit()">Flag for Review</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div class="modal fade modal-confirm" id="deleteModal<%= conversation.id %>" tabindex="-1" aria-labelledby="deleteModalLabel<%= conversation.id %>" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="deleteModalLabel<%= conversation.id %>">Delete Conversation</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p class="mb-0">Are you sure you want to delete this conversation? This action cannot be undone.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary btn-modal" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger btn-modal" onclick="document.getElementById('delete-form-<%= conversation.id %>').submit()">Delete</button>
        </div>
      </div>
    </div>
  </div>
<% end %>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.conversation-checkbox');
    const forms = document.querySelectorAll('form');
    const bulkActionsContainer = document.querySelector('.bulk-actions-container');

    function addSelectedConversationsToForm(form) {
      form.querySelectorAll('input[name="conversation_ids[]"]').forEach(input => input.remove());

      const selectedIds = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      selectedIds.forEach(id => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'conversation_ids[]';
        hiddenInput.value = id;
        form.appendChild(hiddenInput);
      });
    }

    forms.forEach(form => {
      form.addEventListener('submit', function(event) {
        addSelectedConversationsToForm(form);
      });
    });

    function toggleActionButtons() {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      bulkActionsContainer.classList.toggle('visible', anyChecked);
    }

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', toggleActionButtons);
    });

    toggleActionButtons();
  });
</script>
