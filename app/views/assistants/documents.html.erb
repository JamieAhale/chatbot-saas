<!-- app/views/assistants/documents.html.erb -->
<h1>Documents</h1>

<%= form_with url: upload_document_path, local: true, html: { multipart: true }, class: 'mb-4' do |form| %>
  <div class="row g-2 align-items-center mt-4">
    <div class="col-auto col-md-11">
      <%= form.file_field :file, class: 'form-control' %>
    </div>
    <div class="col-auto col-md-1">
      <%= form.submit "Upload", class: 'btn btn-outline-secondary' %>
    </div>
  </div>
<% end %>

<%= form_with url: initiate_scrape_path, method: :post, local: true, class: 'mb-4' do |form| %>
  <div class="row g-2 align-items-center mt-4">
    <div class="col-auto col-md-11">
      <%= form.text_field :website_url, class: 'form-control', placeholder: 'Enter website URL (include https:// prefix)' %>
    </div>
    <div class="col-auto col-md-1">
      <%= form.submit "Extract", class: 'btn btn-outline-secondary' %>
    </div>
  </div>
<% end %>

<% if @files.any? %>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Name</th>
        <th>Status</th>
        <th>Uploaded</th>
        <th> </th>
      </tr>
    </thead>
    <tbody>
      <% @files.each do |file| %>
        <tr>
          <td><%= file['name'] %></td>
          <td>
            <% status_class = case file['status']
              when 'Available' then 'badge bg-success'
              when 'Processing' then 'badge bg-warning text-dark'
              when 'Deleting' then 'badge bg-danger'
              else 'badge bg-secondary'
            end %>
            <span class="<%= status_class %>"><%= file['status'].capitalize %></span>
          </td>
          <td data-timestamp="<%= file['updated_on'] %>"></td>
          <td class="text-center align-middle">
            <div class="dropdown">
              <button class="btn dropdown-toggle" type="button" id="dropdownMenuButton<%= file['id'] %>" data-bs-toggle="dropdown" aria-expanded="false" style="font-size: 25px; color: #333; font-weight: bold;">
                &#x22EE;
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton<%= file['id'] %>">
                <li>
                  <%= link_to 'View', view_document_path(file_id: file['id']), class: 'dropdown-item', target: '_blank' %>
                </li>
                <% if file['name'].end_with?(' (Extracted Website Content).pdf') && file['status'] == 'Available' %>
                  <li>
                    <%= button_to 'Refresh',
                        refresh_website_content_assistants_path(
                          file_id: file['id'],
                          website_url: "https://#{file['name'].sub(' (Extracted Website Content).pdf', '')}"
                        ),
                        method: :post,
                        class: 'dropdown-item',
                        onclick: "return confirm('Are you sure you want to refresh this website content? This will delete the current document and initiate a new scrape.');" %>
                  </li>
                <% end %>
                <li>
                  <%= button_to 'Delete', delete_document_path(file_id: file['id']), method: :post, class: 'dropdown-item', onclick: "return confirm('Are you sure you want to delete this document?');" %>
                </li>
              </ul>
            </div>
          </td>
        </tr>
      <% end %>
    </tbody>
  </table>
<% else %>
  <p>No documents found.</p>
<% end %>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const timestampElements = document.querySelectorAll('[data-timestamp]');

  timestampElements.forEach(element => {
    const timestamp = element.getAttribute('data-timestamp');
    const date = new Date(timestamp);
    const formattedDate = date.toLocaleString(undefined, {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit',
      hour12: true
    });
    element.textContent = formattedDate;
  });
});
</script>

<style>
  .dropdown-toggle {
    background-color: transparent !important;
    border: none !important;
    color: #333 !important;
    font-size: 10px;
    font-weight: bold;
    padding: 0;
    text-decoration: none !important;
  }
  .dropdown-toggle::after {
    display: none !important;
  }

  /* Standard Button Styles */
  .btn-outline-secondary {
    color: #6c757d;
    border-color: #6c757d;
    background-color: white;
    transition: all 0.3s ease;
  }

  .btn-outline-secondary:hover {
    color: white;
    background-color: #6c757d;
    border-color: #6c757d;
  }

  .btn-outline-secondary:focus {
    box-shadow: 0 0 0 0.25rem rgba(108, 117, 125, 0.25);
  }
</style>
