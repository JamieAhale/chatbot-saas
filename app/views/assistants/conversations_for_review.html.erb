<style>
  .pagination .page-item .page-link {
    color: #6c757d; /* Grey color for text */
  }

  .pagination .page-item.active .page-link {
    background-color: #6c757d; /* Grey color for active background */
    border-color: #6c757d; /* Grey color for active border */
    color: white; /* White text for active page */
  }

  .pagination .page-item .page-link:hover {
    color: #5a6268; /* Slightly darker grey on hover */
  }

  /* Animation styles for bulk actions */
  .bulk-actions-container {
    max-height: 0;
    overflow: hidden;
    opacity: 0;
    transition: all 0.3s ease-in-out;
    margin-top: 0;
    margin-bottom: 0;
  }

  .bulk-actions-container.visible {
    max-height: 50px;
    opacity: 1;
    margin-bottom: 1rem;
  }

  .bulk-action-btn {
    transform: translateY(0);
    transition: transform 0.3s ease-in-out;
  }
</style>

<div>
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">Conversations for Review</h1>
    <div class="d-flex">
      <% if params[:search].present? %>
        <%= link_to conversations_for_review_path, class: "btn btn-outline-secondary me-2" do %>
          <i class="fas fa-times me-1"></i> Clear Search
        <% end %>
      <% end %>

      <%= form_with url: conversations_for_review_path, method: :get, local: true, class: 'd-flex' do %>
        <div class="input-group">
          <%= text_field_tag :search, params[:search], class: 'form-control', placeholder: 'Search conversations...' %>
          <button type="submit" class="btn btn-outline-secondary">
            <i class="fas fa-search"></i>
          </button>
        </div>
      <% end %>
    </div>
  </div>

  <% if @conversations.any? %>
    <!-- Form for deleting selected conversations -->
    <div class="bulk-actions-container">
      <div class="d-flex">
        <%= form_with url: delete_selected_conversations_path, method: :delete, local: true, id: 'delete_conversations_form' do %>
          <%= submit_tag "Delete Selected", class: "btn btn-danger me-2 bulk-action-btn", onClick: "return confirm('Are you sure you want to delete the selected conversations? This cannot be undone.')", id: 'delete_selected_button' %>
        <% end %>

        <%= form_with url: mark_resolved_conversations_path, method: :patch, local: true, id: 'mark_resolved_form' do %>
          <%= submit_tag "Mark Selected as Resolved", class: "btn btn-success me-2 bulk-action-btn", onClick: "return confirm('Are you sure you want to mark the selected conversations as resolved?')", id: 'mark_resolved_button' %>
        <% end %>

        <%= form_with url: dismiss_conversations_path, method: :patch, local: true, id: 'dismiss_conversations_form' do %>
          <%= submit_tag "Dismiss Selected", class: "btn btn-secondary bulk-action-btn", onClick: "return confirm('Are you sure you want to dismiss the selected conversations?')", id: 'dismiss_selected_button' %>
        <% end %>
      </div>
    </div>

    <table class="table table-striped mt-1 uniform-table">
      <thead>
        <tr>
          <th> </th>
          <th>Title</th>
          <th>ID</th>
          <th>Total Messages</th>
          <th>Date</th>
        </tr>
      </thead>
      <tbody>
        <% @conversations.each do |conversation| %>
          <tr>
            <td>
              <%= check_box_tag "conversation_ids[]", conversation.id, false, class: 'conversation-checkbox' %>
            </td>
            <td>
              <%= link_to (conversation.title.presence || "Untitled").gsub(/\A"|"\Z/, ''), show_conversation_for_review_path(conversation, search: params[:search]), class: "text-danger fw-bold text-decoration-underline" %>
            </td>
            <td>
              <%= conversation.id %>
            </td>
            <td>
              <%= conversation.query_and_responses.count * 2 %>
            </td>
            <td>
              <%= conversation.created_at.strftime("#{conversation.created_at.day.ordinalize} %B %Y") %>
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>

    <div class="d-flex justify-content-center mb-4">
      <nav aria-label="Page navigation">
        <ul class="pagination">
          <% if @conversations.current_page > 1 %>
            <li class="page-item">
              <%= link_to 'Previous', conversations_for_review_path(page: @conversations.current_page - 1), class: 'page-link' %>
            </li>
          <% end %>

          <% (1..@conversations.total_pages).each do |page| %>
            <li class="page-item <%= 'active' if page == @conversations.current_page %>">
              <%= link_to page, conversations_for_review_path(page: page), class: 'page-link' %>
            </li>
          <% end %>

          <% if @conversations.current_page < @conversations.total_pages %>
            <li class="page-item">
              <%= link_to 'Next', conversations_for_review_path(page: @conversations.current_page + 1), class: 'page-link' %>
            </li>
          <% end %>
        </ul>
      </nav>
    </div>
  <% else %>
    <p class="mt-4">No conversations flagged for review.</p>
  <% end %>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const checkboxes = document.querySelectorAll('.conversation-checkbox');
    const forms = document.querySelectorAll('form');
    const bulkActionsContainer = document.querySelector('.bulk-actions-container');

    function addSelectedConversationsToForm(form) {
      form.querySelectorAll('input[name="conversation_ids[]"]').forEach(input => input.remove());

      const selectedIds = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      selectedIds.forEach(id => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'conversation_ids[]';
        hiddenInput.value = id;
        form.appendChild(hiddenInput);
      });
    }

    forms.forEach(form => {
      form.addEventListener('submit', function(event) {
        addSelectedConversationsToForm(form);
      });
    });

    function toggleActionButtons() {
      const anyChecked = Array.from(checkboxes).some(cb => cb.checked);
      bulkActionsContainer.classList.toggle('visible', anyChecked);
    }

    checkboxes.forEach(checkbox => {
      checkbox.addEventListener('change', toggleActionButtons);
    });

    toggleActionButtons();
  });
</script> 