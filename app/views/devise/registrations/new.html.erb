<h2 class="text-center mb-4 mt-5">Sign up</h2>

<div class="container" style="max-width: 600px;">
  <%= form_for(resource, as: resource_name, url: registration_path(resource_name), html: { id: 'registration-form', class: 'form-horizontal' }) do |f| %>
    <%= render "devise/shared/error_messages", resource: resource %>

    <div class="mb-3">
      <%= f.label :first_name, class: 'form-label' %>
      <%= f.text_field :first_name, autofocus: true, autocomplete: "first_name", class: 'form-control' %>
    </div>

    <div class="mb-3">
      <%= f.label :last_name, class: 'form-label' %>
      <%= f.text_field :last_name, autocomplete: "last_name", class: 'form-control' %>
    </div>

    <div class="mb-3">
      <%= f.label :email, class: 'form-label' %>
      <%= f.email_field :email, autocomplete: "email", class: 'form-control' %>
    </div>

    <div class="mb-3">
      <%= f.label :password, class: 'form-label' %>
      <% if @minimum_password_length %>
        <em>(<%= @minimum_password_length %> characters minimum)</em>
      <% end %>
      <%= f.password_field :password, autocomplete: "new-password", class: 'form-control' %>
    </div>

    <div class="mb-3">
      <%= f.label :password_confirmation, class: 'form-label' %>
      <%= f.password_field :password_confirmation, autocomplete: "new-password", class: 'form-control' %>
    </div>
    
    <hr class="my-5">
    
    <div class="mb-4">
      <h4 class="text-center mb-3">Choose Your Plan</h4>
      <p class="text-center text-muted mb-4">Scale your AI assistant capabilities as your business grows</p>
      
      <div class="row row-cols-1 row-cols-md-3 g-4 mb-4">
        <!-- Lite Plan -->
        <div class="col">
          <div class="card h-100 plan-card" data-plan-id="<%= @plans['Lite - $99/month'] %>">
            <div class="card-body">
              <h5 class="card-title text-center mb-2">Lite</h5>
              <h6 class="text-center text-primary mb-3">$99/month</h6>
              <p class="text-center text-muted mb-4">Perfect for small businesses just getting started</p>
              
              <ul class="list-unstyled">
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>500 AI Queries/month</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Basic Widget Customization</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Email Support</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Basic Analytics</li>
                <li class="mb-2 text-muted"><i class="fas fa-times text-muted me-2"></i>Review Analytics</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Basic Plan -->
        <div class="col">
          <div class="card h-100 plan-card" data-plan-id="<%= @plans['Basic - $249/month'] %>">
            <div class="card-body">
              <div class="position-absolute top-0 start-50 translate-middle">
                <span class="badge bg-primary px-3 py-2">Most Popular</span>
              </div>
              <h5 class="card-title text-center mb-2">Basic</h5>
              <h6 class="text-center text-primary mb-3">$249/month</h6>
              <p class="text-center text-muted mb-4">Ideal for growing businesses</p>
              
              <ul class="list-unstyled">
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>2,000 AI Queries/month</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Advanced Widget Customization</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Priority Support</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Advanced Analytics</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Review Analytics</li>
              </ul>
            </div>
          </div>
        </div>

        <!-- Pro Plan -->
        <div class="col">
          <div class="card h-100 plan-card" data-plan-id="<%= @plans['Pro - $499/month'] %>">
            <div class="card-body">
              <h5 class="card-title text-center mb-2">Pro</h5>
              <h6 class="text-center text-primary mb-3">$499/month</h6>
              <p class="text-center text-muted mb-4">For businesses that need maximum power</p>
              
              <ul class="list-unstyled">
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>10,000 AI Queries/month</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Full Widget Customization</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>24/7 Priority Support</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Enterprise Analytics</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Advanced Review Analytics</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
      <%= f.hidden_field :plan, id: 'selected-plan' %>
    </div>

    <!-- Stripe Elements Placeholder -->
    <div class="mb-3">
      <label class="form-label">Credit or Debit Card</label>
      <div id="card-element" class="form-control"></div>
      <div id="card-errors" class="text-danger mt-2"></div>
    </div>

    <!-- Submit Button -->
    <div class="d-grid">
      <%= f.submit "Sign Up & Pay", class: 'btn btn-primary' %>
    </div>
  <% end %>

  <div class="text-center mt-4 mb-5">
    <%= render "devise/shared/links" %>
  </div>
</div>

<!-- Include Stripe.js -->
<script src="https://js.stripe.com/v3/"></script>
<script>
  document.addEventListener("DOMContentLoaded", () => {
    const stripe = Stripe('<%= ENV["STRIPE_PUBLIC_KEY"] %>');
    const elements = stripe.elements();
    const card = elements.create('card');
    card.mount('#card-element');

    const form = document.getElementById('registration-form');
    form.addEventListener('submit', async (event) => {
      event.preventDefault();

      const { token, error } = await stripe.createToken(card);
      if (error) {
        document.getElementById('card-errors').textContent = error.message;
      } else {
        const hiddenInput = document.createElement('input');
        hiddenInput.setAttribute('type', 'hidden');
        hiddenInput.setAttribute('name', 'stripeToken');
        hiddenInput.setAttribute('value', token.id);
        form.appendChild(hiddenInput);
        form.submit();
      }
    });
  });

  document.addEventListener('DOMContentLoaded', function() {
    const planCards = document.querySelectorAll('.plan-card');
    const selectedPlanInput = document.getElementById('selected-plan');

    // Set default selection
    const defaultCard = planCards[0];
    if (defaultCard) {
      defaultCard.classList.add('selected');
      selectedPlanInput.value = defaultCard.dataset.planId;
    }

    planCards.forEach(card => {
      card.addEventListener('click', function() {
        // Remove selected class from all cards
        planCards.forEach(c => c.classList.remove('selected'));
        
        // Add selected class to clicked card
        this.classList.add('selected');
        
        // Update hidden input value
        selectedPlanInput.value = this.dataset.planId;
      });
    });
  });
</script>
